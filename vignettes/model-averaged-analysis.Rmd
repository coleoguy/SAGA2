---
title: "SAGA2: Model-Averaged Line Cross Analysis"
author: "Heath Blackmon, Andrew Armstrong, and Jeffery P. Demuth"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SAGA2: Model-Averaged Line Cross Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 4
)
```

# Introduction

Line cross analysis (LCA) partitions the contribution of composite genetic
effects (CGEs) to the mean phenotype of cohorts derived from crosses between
divergent parental strains. Traditional LCA uses the joint-scaling test, which
has well-documented problems including reliance on stepwise model selection.

SAGA2 implements a full information-theoretic (I-T) approach to LCA that uses
the corrected Akaike information criterion ($AICc$) to explore all possible
models and produce model-averaged parameter estimates with unconditional
standard errors. A key improvement in SAGA2 over the original SAGA is that
users simply supply their breeding design and the software automatically
constructs the appropriate C-matrix.

**Functions:**

- `LCA()`: Primary analysis function --- generates and tests all models.
- `EvaluateModel()`: Examine parameter estimates from a single model.
- `VisModelSpace()`: Visualize the distribution of Akaike weights across
  model space.
- `plotObserved()`: Traditional LCA plot of observed data with additive
  expectation.
- `plot.genarch()`: S3 plot method for publication-quality figures of
  model-averaged results.

# Installation

Install the development version from GitHub:

```{r install, eval = FALSE}
# install.packages("remotes")
remotes::install_github("coleoguy/SAGA2")
```

# Quick Start

```{r quickstart}
library(SAGA2)

# Load the example dataset
data(BanInf)
head(BanInf)

# Run the analysis
result <- LCA(BanInf, SCS = "NSC", messages = FALSE)

# View model-averaged estimates
result$estimates
```

# Preparing Data

Data for SAGA2 must be a data frame with 7 columns:

| Column   | Description |
|----------|-------------|
| `cross`  | Name of each cohort (e.g., "P1", "P2", "F1", "rF1") |
| `mean`   | Mean phenotype of the cohort |
| `SE`     | Standard error of the cohort mean |
| `sex`    | Sex: "M", "F", "E" (equal ratio), or "U" (unknown) |
| `enviro` | Environmental variable (numeric, or `NA`) |
| `sire`   | Row number of the sire in the data frame |
| `dam`    | Row number of the dam in the data frame |

Important notes:

- `P1` and `P2` must be present as the two parental strains.
- For parental lines, `sire` and `dam` should point to the line's own row.
- Environmental values will be automatically rescaled to [-1, 1] if needed.

# Detailed Walkthrough

## Running the Analysis

The `LCA()` function is the main entry point. It accepts several arguments
to control the analysis:

```{r analysis}
# Full analysis with NSC (no sex chromosomes)
result <- LCA(
  data = BanInf,
  SCS = "NSC",          # No sex chromosome system
  model.sum = 0.95,     # 95% confidence set of models
  messages = FALSE
)
```

The returned object is of class `"genarch"` and contains:

```{r results}
# Model-averaged parameter estimates and unconditional SEs
result$estimates

# Variable importance scores
result$varimp

# The C-matrix used in the analysis
head(result$cmatrix)
```

## Plotting Model-Averaged Results

The S3 `plot()` method for `"genarch"` objects creates a barplot of
model-weighted average estimates with unconditional standard error bars.
Bar color reflects variable importance.

```{r plot-results, fig.width=7, fig.height=5}
plot(result, min.vi = 0.3)
```

The `min.vi` argument controls which CGEs appear in the plot --- only those
with variable importance at or above the threshold are shown.

## Plotting Observed Data

The `plotObserved()` function creates a traditional LCA plot showing cohort
phenotypes as a function of the percentage of parent 1 genome, with the
additive expectation overlaid:

```{r plot-observed, fig.width=6, fig.height=5}
plotObserved(BanInf)
```

## Visualizing Model Space

`VisModelSpace()` displays every evaluated model as a colored square, with
color indicating Akaike weight. Models are arranged from simplest
(bottom-left) to most complex (top-right):

```{r model-space, fig.width=7, fig.height=5}
VisModelSpace(result)
```

## Evaluating Individual Models

To examine a specific model in detail, use `EvaluateModel()`. This requires
the analysis to have been run with `ret.all = TRUE`:

```{r eval-model, fig.width=6, fig.height=5}
result2 <- LCA(BanInf, SCS = "NSC", ret.all = TRUE, messages = FALSE)

# Evaluate the first model
eval1 <- EvaluateModel(result2, model = 1)
eval1$Estiamtes
eval1$P.val
```

# Advanced Usage

## Controlling Model Space

For datasets with many cohorts, the number of possible models can be very
large. Use `max.pars` to limit the maximum number of parameters per model:

```{r max-pars, eval = FALSE}
result <- LCA(BanInf, SCS = "NSC", max.pars = 4, messages = FALSE)
```

## Dropping or Keeping Specific CGEs

You can exclude specific composite genetic effects with `drop.pars` or
restrict the analysis to only certain effects with `keep.pars`:

```{r drop-keep, eval = FALSE}
# Drop maternal effects
result <- LCA(BanInf, SCS = "NSC", drop.pars = c("Mea", "Med"),
              messages = FALSE)

# Keep only additive and dominance effects
result <- LCA(BanInf, SCS = "NSC", keep.pars = c("Aa", "Ad"),
              messages = FALSE)
```

## Observed Parental Effects

By default, maternal effects are calculated from autosomal additive and
dominance coefficients. Setting `parental = "obs"` instead uses the
observed phenotypic values of parental lines, rescaled to [-1, 1]:

```{r parental, eval = FALSE}
result <- LCA(BanInf, SCS = "NSC", parental = "obs", messages = FALSE)
```

# References

1. Blackmon, H. and Demuth, J.P. (2016). An information-theoretic approach
   to estimating the composite genetic effects contributing to variation
   among generation means: Moving beyond the joint-scaling test for line
   cross analysis. *Evolution*, 70(2), 420--432.

2. Burnham, K.P. and Anderson, D.R. (2002). *Model selection and multimodel
   inference: a practical information-theoretic approach*. Springer.

3. Lynch, M. and Walsh, B. (1998). *Genetics and analysis of quantitative
   traits*. Sinauer Associates, Inc.

4. Demuth, J.P. (2004). Evolution of Hybrid Incompatibility in the beetle
   *Tribolium castaneum*. PhD thesis, Indiana University.
